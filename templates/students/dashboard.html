{% extends 'base_generic.html' %}
{% block background_image %}
<style>body{background:none !important;}</style>
{% endblock %}
{% block content %}
<div class="dashboard-header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;">
    <div>
        <h1 style="margin:0;font-size:1.75rem;">Student Dashboard</h1>
    <p style="margin:0.25rem 0 0;color:#555;">Welcome, <strong>{{ student.user.username }}</strong></p>
    <!-- Debug info: shows the current authenticated user from the request -->
    <p style="margin:0.25rem 0 0;color:#999;font-size:0.9rem;">(Logged in as: <strong>{{ request.user.username }}</strong>; user id: <strong>{{ request.user.id }}</strong>)</p>
    </div>
    <div>
        {% if not room %}
            <a class="btn btn-primary" href="{% url 'students:apply_room' %}">Apply for Room</a>
        {% else %}
            <span class="badge" style="background:#28a745;color:white;padding:0.5rem 0.75rem;border-radius:0.375rem;">Room Assigned</span>
        {% endif %}
    </div>
</div>

{% if alerts %}
<div class="alerts" style="margin-bottom:1rem;">
    <ul style="margin:0;padding-left:1.25rem;color:#a94442;background:#f2dede;border:1px solid #ebccd1;border-radius:4px;padding:0.75rem;">
    {% for alert in alerts %}
        <li>{{ alert }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row" style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;">
    <div class="card" style="flex:1 1 220px;padding:1rem;border:1px solid #e0e0e0;border-radius:8px;">
        <h3 style="margin-top:0;margin-bottom:0.5rem;font-size:1.05rem;">Room</h3>
        {% if room %}
            <p style="margin:0;color:#333;">Room <strong>#{{ room.number }}</strong></p>
            <p style="margin:0;color:#666;">Capacity: {{ room.capacity }} | Status: {% if room.is_available %}<span style="color:#28a745;">Available</span>{% else %}<span style="color:#dc3545;">Occupied</span>{% endif %}</p>
            <div style="margin-top:0.5rem;">
                {% if assigned_bed %}
                    <small>Bed: <strong>{{ assigned_bed.bed_number }}</strong></small>
                {% else %}
                    <small>No bed assigned</small>
                {% endif %}
            </div>
        {% else %}
            <p style="margin:0;color:#666;">You have not been assigned a room yet.</p>
        {% endif %}
    </div>

    <div class="card" style="flex:1 1 220px;padding:1rem;border:1px solid #e0e0e0;border-radius:8px;">
        <h3 style="margin-top:0;margin-bottom:0.5rem;font-size:1.05rem;">Payments</h3>
        {% if payments %}
            <p style="margin:0;color:#333;">Total: <strong>{{ payments|length }}</strong></p>
            <p style="margin:0;color:#666;">View your latest payments below.</p>
        {% else %}
            <p style="margin:0;color:#666;">No payment records found.</p>
        {% endif %}
    </div>

    <div class="card" style="flex:1 1 220px;padding:1rem;border:1px solid #e0e0e0;border-radius:8px;">
        <h3 style="margin-top:0;margin-bottom:0.5rem;font-size:1.05rem;">Complaints</h3>
        <p style="margin:0;color:#333;">Submitted: <strong>{{ complaints|length }}</strong></p>
        <p style="margin:0;color:#666;">File and track complaints from here.</p>
    </div>
</div>

<div class="main-content" style="display:flex;gap:1.5rem;flex-wrap:wrap;">
    <div class="panel" style="flex:2 1 520px;border:1px solid #e9ecef;border-radius:8px;padding:1rem;background:white;">
        <h4 style="margin-top:0;margin-bottom:0.75rem;">Recent Payments</h4>
        {% if payments %}
        <table style="width:100%;border-collapse:collapse;">
            <thead>
                <tr style="text-align:left;border-bottom:1px solid #e9ecef;color:#333;">
                    <th style="padding:0.5rem 0">Amount</th>
                    <th style="padding:0.5rem 0">Status</th>
                    <th style="padding:0.5rem 0">Due Date</th>
                </tr>
            </thead>
            <tbody>
            {% for payment in payments %}
                <tr style="border-bottom:1px solid #f1f1f1;">
                    <td style="padding:0.5rem 0">{{ payment.amount }}</td>
                    <td style="padding:0.5rem 0">{% if payment.status == 'Due' %}<span style="color:#dc3545">{{ payment.status }}</span>{% else %}<span style="color:#28a745">{{ payment.status }}</span>{% endif %}</td>
                    <td style="padding:0.5rem 0">{{ payment.due_date }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p style="margin:0;color:#666;">No payments found.</p>
        {% endif %}
    </div>

    <div class="panel" style="flex:1 1 300px;border:1px solid #e9ecef;border-radius:8px;padding:1rem;background:white;">
        <h4 style="margin-top:0;margin-bottom:0.75rem;">Recent Complaints</h4>
        {% if complaints %}
            <ul style="margin:0;padding-left:1rem;color:#333;">
            {% for complaint in complaints|slice:":5" %}
                <li style="margin-bottom:0.5rem;">{{ complaint.title }} <br><small style="color:#666;">{{ complaint.status }} &middot; {{ complaint.created_at|date:"M d, Y" }}</small></li>
            {% endfor %}
            </ul>
            <p style="margin-top:0.75rem;"><a href="{% url 'students:student_complaint_new' %}" class="btn btn-sm btn-outline-primary">Submit New Complaint</a></p>
        {% else %}
            <p style="margin:0;color:#666;">No complaints found.</p>
            <p style="margin-top:0.75rem;"><a href="{% url 'students:student_complaint_new' %}" class="btn btn-sm btn-outline-primary">Submit New Complaint</a></p>
        {% endif %}
        
        <hr style="margin:1rem 0 0.5rem 0;border:none;border-top:1px solid #f1f1f1;">
        <h4 style="margin-top:0.5rem;margin-bottom:0.75rem;">Recent Applications</h4>
        {% if applications %}
            <ul style="margin:0;padding-left:1rem;color:#333;">
            {% for app in applications|slice:":5" %}
                <li style="margin-bottom:0.5rem;">{{ app.reason|truncatechars:60 }} <br><small style="color:#666;">{{ app.status }} &middot; {{ app.created_at|date:"M d, Y" }}</small></li>
            {% endfor %}
            </ul>
            <p style="margin-top:0.75rem;"><a href="{% url 'students:apply_room' %}" class="btn btn-sm btn-outline-primary">Submit Application</a></p>
        {% else %}
            <p style="margin:0;color:#666;">No room applications found.</p>
            <p style="margin-top:0.75rem;"><a href="{% url 'students:apply_room' %}" class="btn btn-sm btn-outline-primary">Submit Application</a></p>
        {% endif %}
    </div>
</div>
{% endblock %}
